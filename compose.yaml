# provide a name if you wish
# name: btlz-test

networks:
    postgres-net:
        driver: bridge

volumes:
    postgres-vol:
        driver: local

services:
    postgres:
        container_name: postgres

        image: postgres:16.1-alpine

        environment:
            - PGPORT=5432
            - POSTGRES_DB=postgres
            - POSTGRES_USER=postgres
            - POSTGRES_PASSWORD=postgres
            - PGDATA=/var/lib/postgresql/data/pgdata

        volumes:
            - postgres-vol:/var/lib/postgresql/data

        networks:
            - postgres-net

        expose:
            - 5432

        ports:
            - 5432:5432

        healthcheck:
            test: ["CMD-SHELL", "pg_isready -U postgres -d postgres"]
            interval: 10s
            timeout: 5s
            retries: 5
            start_period: 10s

        restart: unless-stopped

    app:
        container_name: app

        build:
            context: .
            dockerfile: Dockerfile

        environment:
            POSTGRES_HOST: postgres
            POSTGRES_PORT: 5432
            POSTGRES_DB: postgres
            POSTGRES_USER: postgres
            POSTGRES_PASSWORD: postgres
            PORT: 5432
            NODE_ENV: production
            WB_API_TOKEN: ${WB_API_TOKEN}
            GOOGLE_SHEETS_CREDENTIALS: ${GOOGLE_SHEETS_CREDENTIALS}
            GOOGLE_SHEETS_SPREADSHEET_IDS: ${GOOGLE_SHEETS_SPREADSHEET_IDS}

        ports:
            - 5000:5000

        depends_on:
            postgres:
                condition: service_healthy
        volumes:
            - ./logs:/app/logs
        networks:
            - postgres-net

        logging:
            driver: json-file
            options:
                max-size: 10m
                max-file: 5

        command: ["npm", "run", "start"]
        restart: unless-stopped
